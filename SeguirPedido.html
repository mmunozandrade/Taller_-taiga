<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Seguir Pedido - Maniaterránia</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 10px; }
        .step-card {
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .step-card.active {
            transform: translateY(-2px);
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.15);
        }
    </style>
</head>
<body class="bg-light">

    <!-- NAVBAR -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <!-- Brand -->
            <a class="navbar-brand d-flex align-items-center" href="Inicio.html">
                <h2 class="mb-0">Meniaterránia</h2>
            </a>
            <div class="d-flex align-items-center">
                <a href="Inicio.html" class="nav-link text-white me-4 fw-semibold">
                    <i class="bi bi-house-door-fill me-1"></i> Inicio
                </a>

                <a href="Carrito.html" class="nav-link text-white me-4 fw-semibold">
                    <i class="bi bi-book-half me-1"></i> Menú
                </a>

                <a href="CarritoPago.html" class="nav-link text-white position-relative">
                    <i class="bi bi-cart3" style="font-size:1.5rem;">Carrito</i>
                    <span id="cart-count"
                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        0
                    </span>
                </a>

                <a href="Perfil.html" class="nav-link text-white me-3">
                    <i class="bi bi-person-circle" style="font-size:1.5rem;"></i>
                </a>

                <a href="DatosCifrados.html" class="nav-link text-white me-4 fw-semibold">
                    <i class="bi bi-book-half me-1"></i> Empleados
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="bi bi-geo-alt"></i>
                    Seguimiento de Pedido <span id="numeroPedido">#PED-001</span>
                </h4>
                <small class="d-block mt-1" id="fechaPedido">Fecha: --/--/---- --:--</small>
                <small class="d-block" id="totalPedido">Total: $0</small>
            </div>
            <div class="card-body" id="contenidoSeguimiento">
                <div class="text-center mb-4">
                    <img src="https://via.placeholder.com/800x400/e9ecef/6c757d?text=Mapa+No+Disponible+Sin+JavaScript" 
                        class="img-fluid rounded border" 
                        alt="Mapa de seguimiento">
                    <p class="text-muted mt-2">Para ver el mapa interactivo se requiere JavaScript</p>
                </div>

                <div class="mb-3">
                    <strong>Cliente:</strong> <span id="clienteNombre">No informado</span><br>
                    <strong>Dirección:</strong> <span id="clienteDireccion">No informada</span>
                </div>

                <div class="row text-center" id="stepsRow">
                    <div class="col-md-3 mb-3">
                        <div id="step-confirmado" class="border rounded p-3 bg-success text-white step-card">
                            <i class="bi bi-check-circle display-6"></i>
                            <h6 class="mt-2 mb-0">Confirmado</h6>
                            <small>Pedido registrado</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div id="step-retiro" class="border rounded p-3 bg-warning text-dark step-card">
                            <i class="bi bi-box-seam display-6"></i>
                            <h6 class="mt-2 mb-0">Listo para retiro</h6>
                            <small>Preparando despacho</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div id="step-camino" class="border rounded p-3 bg-info text-white step-card">
                            <i class="bi bi-truck display-6"></i>
                            <h6 class="mt-2 mb-0">En camino</h6>
                            <small>Repartidor en ruta</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div id="step-entregado" class="border rounded p-3 bg-secondary text-white step-card">
                            <i class="bi bi-house display-6"></i>
                            <h6 class="mt-2 mb-0">Entregado</h6>
                            <small>Próximamente</small>
                        </div>
                    </div>
                </div>

                <p class="text-muted small mb-0">
                    El estado cambiará automáticamente: "Listo para retiro" → "En camino" → "Entregado".
                </p>
            </div>
        </div>
    </div>

<script>
    const cartCountSpan = document.getElementById("cart-count");
    const numeroPedidoSpan = document.getElementById("numeroPedido");
    const fechaPedidoSpan  = document.getElementById("fechaPedido");
    const totalPedidoSpan  = document.getElementById("totalPedido");
    const clienteNombreSpan    = document.getElementById("clienteNombre");
    const clienteDireccionSpan = document.getElementById("clienteDireccion");
    const contenidoSeguimiento = document.getElementById("contenidoSeguimiento");

    const stepConfirmado = document.getElementById("step-confirmado");
    const stepRetiro     = document.getElementById("step-retiro");
    const stepCamino     = document.getElementById("step-camino");
    const stepEntregado  = document.getElementById("step-entregado");

    // Recuperamos el seguimiento guardado desde BoletaElectronica
    const seguimiento = JSON.parse(localStorage.getItem("seguimientoPedido") || "null");

    const estados = ["Listo para retiro", "En camino", "Entregado"];

    function resetStepClasses() {
        [stepConfirmado, stepRetiro, stepCamino, stepEntregado].forEach(step => {
            if (!step) return;
            step.className = step.className
                .replace(/bg-\w+/g, "")   // limpia fondos previos
                .replace(/active/g, "")
                .trim();
            step.classList.add("border", "rounded", "p-3", "step-card");
        });
    }

    function aplicarEstadoVisual(estadoActual) {
        if (!stepConfirmado) return;
        resetStepClasses();

        // Confirmado siempre completado
        stepConfirmado.classList.add("bg-success", "text-white", "active");

        // Mapeamos el estado actual a un índice
        let indice = estados.indexOf(estadoActual);
        if (indice === -1) indice = 0;

        // Base: todos como "pendiente"
        stepRetiro.classList.add("bg-secondary", "text-white");
        stepCamino.classList.add("bg-secondary", "text-white");
        stepEntregado.classList.add("bg-secondary", "text-white");

        // Según estado, vamos completando
        if (indice >= 0) {
            stepRetiro.classList.remove("bg-secondary");
            stepRetiro.classList.add("bg-warning", "text-dark", "active");
        }
        if (indice >= 1) {
            stepRetiro.classList.remove("bg-warning", "text-dark");
            stepRetiro.classList.add("bg-success", "text-white");
            stepCamino.classList.remove("bg-secondary");
            stepCamino.classList.add("bg-info", "text-white", "active");
        }
        if (indice >= 2) {
            stepCamino.classList.remove("bg-info");
            stepCamino.classList.add("bg-success", "text-white");
            stepEntregado.classList.remove("bg-secondary");
            stepEntregado.classList.add("bg-success", "text-white", "active");
        }
    }

    function formatPrice(n) {
        return '$' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function cargarSeguimiento() {
        if (!seguimiento) {
            contenidoSeguimiento.innerHTML = `
                <p class="text-muted text-center mb-2">
                    No tienes pedidos en seguimiento actualmente.
                </p>
                <div class="text-center">
                    <a href="Carrito.html" class="btn btn-primary btn-sm">Hacer un pedido</a>
                </div>
            `;
            cartCountSpan.textContent = "0";
            return;
        }

        // Encabezado
        numeroPedidoSpan.textContent = seguimiento.numeroBoleta || "#PED-001";
        fechaPedidoSpan.textContent  = "Fecha: " + (seguimiento.fecha || "--/--/---- --:--");
        totalPedidoSpan.textContent  = "Total: " + (seguimiento.total || "$0");

        clienteNombreSpan.textContent    = seguimiento.nombre || "No informado";
        clienteDireccionSpan.textContent = seguimiento.direccion || "No informada";

        // Contar ítems para el cart-count
        let totalItems = 0;
        Object.values(seguimiento.items || {}).forEach(item => {
            totalItems += item.cantidad || 0;
        });
        cartCountSpan.textContent = totalItems.toString();

        aplicarEstadoVisual(seguimiento.estado || "Listo para retiro");
        iniciarCambioEstados();
    }

    function iniciarCambioEstados() {
        if (!seguimiento) return;

        let indice = estados.indexOf(seguimiento.estado);
        if (indice === -1) indice = 0;

        function avanzarEstado() {
            if (indice >= estados.length - 1) {
                return false; // ya está en "Entregado"
            }
            indice++;
            const nuevoEstado = estados[indice];
            seguimiento.estado = nuevoEstado;
            localStorage.setItem("seguimientoPedido", JSON.stringify(seguimiento));
            aplicarEstadoVisual(nuevoEstado);
            return indice < estados.length - 1;
        }

        // Aplicamos el estado actual al entrar
        aplicarEstadoVisual(estados[indice] || "Listo para retiro");

        const intervalId = setInterval(() => {
            const puedeSeguir = avanzarEstado();
            if (!puedeSeguir) {
                clearInterval(intervalId);
            }
        }, 15000); // 15 segundos
    }

    cargarSeguimiento();
</script>

</body>
</html>